<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google OAuth2 Authorization </title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      h1 {
        text-align: center;
      }

      textarea,
      input[type="text"],
      select {
        width: 100%;
        max-width: 600px;
        box-sizing: border-box;
        padding: 10px;
        margin-bottom: 10px;
      }

      button {
        width: 100%;
        max-width: 600px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      button:hover {
        background-color: #45a049;
      }

      label {
        width: 100%;
        max-width: 600px;
        margin-bottom: 5px;
        font-weight: bold;
      }

      pre {
        width: 100%;
        max-width: 600px;
        overflow-x: auto;
        background-color: #f4f4f4;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      @media (max-width: 600px) {
        button,
        textarea,
        input[type="text"],
        select,
        label,
        pre {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Google OAuth2 Authorization - v.1.0</h1>

    <!-- Combo for Credentials -->
    <label for="credentials-select">Select Default Credentials:</label>
    <select id="credentials-select">
      <option value="">-- Select Credentials --</option>
    </select>

    <!-- Input for credentials -->
    <label for="credentials">Paste your Google OAuth2 credentials (JSON):</label>
    <textarea id="credentials" rows="10" cols="50" placeholder="Paste your JSON here..."></textarea>

    <!-- Combo for Scopes -->
    <label for="scopes-select">Select Default Scopes:</label>
    <select id="scopes-select">
      <option value="">-- Select Scopes --</option>
    </select>

    <!-- Input for scopes -->
    <label for="scopes">Scopes (comma-separated):</label>
    <input id="scopes" type="text" placeholder="e.g., https://www.googleapis.com/auth/drive" />

    <button id="generate-url">Generate Authorization URL</button>

    <!-- Authorization URL -->
    <label for="auth-url">Authorization URL:</label>
    <input id="auth-url" type="text" readonly />

    <!-- Token response -->
    <h3>Token Response:</h3>
    <pre id="token-response"></pre>
    <button id="copy-token-response">Copy Token Response</button>

    <!-- Additional Buttons -->
    <button id="refresh-token">Refresh Access Token</button>
    <button id="copy-access-token">Copy Access Token</button>

    <script>
      // Function to extract query parameters from URL
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Helper function to get the appropriate redirect_uri
      function getRedirectUri(redirectUris) {
        if (redirectUris.length === 1) return redirectUris[0];
        return redirectUris.find(uri => uri.startsWith(window.location.origin)) || redirectUris[0];
      }

      //Config
      const defaultConfigurations = {
        credentials: {
          "http-shortcuts-01-o861.codeverify@gmail.com":
            "eyJ3ZWIiOnsiY2xpZW50X2lkIjoiMjM1MzE0MzExMTMzLWUzN3FpaW8xaWdqOGVldGoydXJxaHYxajduY3J0bG1iLmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tIiwicHJvamVjdF9pZCI6Imh0dHAtc2hvcnRjdXRzLTAxIiwiYXV0aF91cmkiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsInRva2VuX3VyaSI6Imh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjoiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwiY2xpZW50X3NlY3JldCI6IkdPQ1NQWC1WSG1MbEt4WXpjTDVLNy1DelJtU0hSX1J4bkJMIiwicmVkaXJlY3RfdXJpcyI6WyJodHRwczovL2dvb2dsZS1hdXRoMi1vbmUudmVyY2VsLmFwcCIsImh0dHBzOi8vbzIyemFsby5naXRodWIuaW8vZ29vZ2xlLWF1dGgyIl19fQ==",
        },
        scopes: {
          "script.run":
            "https://apps-apis.google.com/a/feeds/ https://apps-apis.google.com/a/feeds https://apps-apis.google.com/a/feeds/alias/ https://apps-apis.google.com/a/feeds/groups/ https://mail.google.com/ https://mail.google.com/mail/feed/atom https://mail.google.com https://mail.google.com/mail/feed/atom/ https://mail.google.com/mail https://mail.google.com/mail/ http://mail.google.com/ http://mail.google.com http://sites.google.com/feeds http://sites.google.com/feeds/ https://sites.google.com/feeds https://sites.google.com/feeds/ https://sites.google.com/feeds/#readonly https://www.googleapis.com/auth/calendar https://www.google.com/calendar/feeds/ https://www.google.com/calendar/feeds http://www.google.com/calendar/feeds/default/allcalendars/full https://www.google.com/calendar/feeds/default/owncalendars/full http://www.google.com/calendar/feeds/ http://www.google.com/calendar/feeds https://www.google.com/calendar/feeds/default/private/full http://www.google.com/calendar/feeds/default/private/full http://www.google.com/calendar/feeds/default/owncalendars/full/ https://www.google.com/calendar/feeds/default https://www.google.com/calendar/freebusy https://www.googleapis.com/auth/contacts https://www.google.com/m8/feeds https://www.google.com/m8/feeds/ https://www.google.com/m8/feeds/contacts https://www.google.com/m8/feeds/contacts/ https://www.google.com/m8/feeds/contacts/default/full https://www.google.com/m8/feeds/photos https://www.google.com/m8/feeds/photos/ https://www.google.com/m8/feeds/profiles https://www.google.com/m8/feeds/profiles/ https://www.google.com/m8/feeds/groups https://www.google.com/m8/feeds/groups/ https://www.google.com/m8/feeds/user/ https://www.google.com/m8/feeds/user http://www.google.com/m8/feeds/ http://www.google.com/m8/feeds http://www.google.com/m8/feeds/contacts/ https://www.google.com/m8/feeds/contacts/default/full/ https://www.google.com/m8/feeds/default/full http://www.google.com/m8/feeds/contacts/default/full https://www.google.com/m8/feeds/photo http://www.google.com/m8/feeds/contacts https://www.google.com/m8/feeds/groups/default/full https://picasaweb.google.com/c/ http://www-opensocial.googleusercontent.com/api/people/@me/@self https://www-opensocial.googleusercontent.com/api/people/ http://www-opensocial.googleusercontent.com/api/people/ https://www-opensocial.googleusercontent.com/api/people https://www.googleapis.com/auth/admin.directory.group https://www.googleapis.com/auth/directory.group https://www.googleapis.com/auth/admin.directory.user https://www.googleapis.com/auth/directory.user https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/documents.currentonly https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/dynamiccreatives https://www.googleapis.com/auth/forms https://www.googleapis.com/auth/forms.currentonly https://www.googleapis.com/auth/groups https://www.googleapis.com/auth/script.cpanel https://www.googleapis.com/auth/script.external_request https://www.googleapis.com/auth/script.scriptapp https://www.googleapis.com/auth/script.send_mail https://www.googleapis.com/auth/script.storage https://www.googleapis.com/auth/script.webapp.deploy https://www.googleapis.com/auth/spreadsheets https://spreadsheets.google.com/feeds https://spreadsheets.google.com/feeds/ http://spreadsheets.google.com/feeds http://spreadsheets.google.com/feeds/ https://spreadsheets.google.com/feeds/spreadsheets https://spreadsheets.google.com/feeds/spreadsheets/private/full http://spreadsheets.google.com/feeds/spreadsheets/private/full https://spreadsheets.google.com/feeds/worksheets/ https://spreadsheets.google.com/tq https://spreadsheets.google.com/feeds/list/ https://spreadsheets.google.com/feeds/worksheet/ https://spreadsheets.google.com/feeds/cell/ https://www.googleapis.com/auth/spreadsheets.currentonly https://www.googleapis.com/auth/sqlservice https://www.googleapis.com/auth/userinfo.email email https://www.googleapis.com/auth/userinfo#email",
        },
      };

      // Populate credentials select
      const credentialsSelect = document.getElementById("credentials-select");
      for (const key in defaultConfigurations.credentials) {
        const option = document.createElement("option");
        option.value = defaultConfigurations.credentials[key];
        option.textContent = key;
        credentialsSelect.appendChild(option);
      }

      // Populate scopes select
      const scopesSelect = document.getElementById("scopes-select");
      for (const key in defaultConfigurations.scopes) {
        const option = document.createElement("option");
        option.value = defaultConfigurations.scopes[key];
        option.textContent = key;
        scopesSelect.appendChild(option);
      }

      // Handle credentials select change
      credentialsSelect.addEventListener("change", () => {
        const selected = credentialsSelect.value;
        if (selected) {
          const decoded = JSON.parse(atob(selected));
          document.getElementById("credentials").value = JSON.stringify(decoded, null, 2);
        } else {
          document.getElementById("credentials").value = "";
        }
      });

      // Handle scopes select change
      scopesSelect.addEventListener("change", () => {
        const selected = scopesSelect.value;
        if (selected) {
          document.getElementById("scopes").value = selected;
        } else {
          document.getElementById("scopes").value = "";
        }
      });

      // Handle OAuth2 flow
      async function handleOAuthFlow() {
        const authCode = getQueryParam("code");

        if (authCode) {
          try {
            const credentials = JSON.parse(localStorage.getItem("credentials"));

            if (!credentials || !credentials.web) {
              throw new Error("Credentials not found. Please enter and save them again.");
            }

            const { client_id, client_secret, redirect_uris } = credentials.web;
            const redirect_uri = getRedirectUri(redirect_uris);

            const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({
                code: authCode,
                client_id,
                client_secret,
                redirect_uri,
                grant_type: "authorization_code",
              }),
            });

            const tokenData = await tokenResponse.json();
            console.log("Token Data:", tokenData);
            const combinedData = { ...credentials, ...tokenData };
            console.log("Combined Data:", combinedData);
            document.getElementById("token-response").textContent = JSON.stringify(combinedData, null, 2);

            // Save token data to localStorage
            localStorage.setItem("combinedData", JSON.stringify(combinedData));
          } catch (error) {
            console.error("Error handling OAuth flow:", error);
            alert(`Error handling OAuth flow: ${error.message}`);
          }
        }
      }

      document.getElementById("generate-url").addEventListener("click", () => {
        try {
          const credentials = JSON.parse(document.getElementById("credentials").value);
          const scopes = document
            .getElementById("scopes")
            .value.split(",")
            .map((s) => s.trim());

          if (!credentials.web) throw new Error("Invalid credentials format. Expecting JSON with a `web` key.");

          const { client_id, redirect_uris } = credentials.web;
          const redirect_uri = getRedirectUri(redirect_uris);

          // Save credentials to localStorage for later use
          localStorage.setItem("credentials", JSON.stringify(credentials));

          const params = new URLSearchParams({
            client_id,
            redirect_uri,
            response_type: "code",
            scope: scopes.join(" "),
            access_type: "offline",
            prompt: "consent",
          });

          const authUrl = `https://accounts.google.com/o/oauth2/auth?${params.toString()}`;
          document.getElementById("auth-url").value = authUrl;
          window.location.href = authUrl; // Redirect to auth URL
        } catch (error) {
          console.error("Error generating URL:", error);
          alert(`Error generating URL: ${error.message}`);
        }
      });

      // Refresh Token Functionality
      document.getElementById("refresh-token").addEventListener("click", async () => {
        try {
          const combinedData = JSON.parse(localStorage.getItem("combinedData"));

          if (!combinedData || !combinedData.refresh_token) {
            throw new Error("Token or credentials not found. Please authenticate again.");
          }

          const { client_id, client_secret, redirect_uris } = combinedData.web;
          const redirect_uri = getRedirectUri(redirect_uris);

          const refreshResponse = await fetch("https://oauth2.googleapis.com/token", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              client_id,
              client_secret,
              refresh_token: combinedData.refresh_token,
              redirect_uri,
              grant_type: "refresh_token",
            }),
          });

          const refreshedData = await refreshResponse.json();
          console.log("Refreshed Data:", refreshedData);
          combinedData.access_token = refreshedData.access_token;
          combinedData.expires_in = refreshedData.expires_in;

          console.log("Updated Combined Data:", combinedData);
          localStorage.setItem("combinedData", JSON.stringify(combinedData));
          document.getElementById("token-response").textContent = JSON.stringify(combinedData, null, 2);

          alert("Access token refreshed successfully!");
        } catch (error) {
          console.error("Error refreshing token:", error);
          alert(`Error refreshing token: ${error.message}`);
        }
      });

      // Copy Access Token Functionality
      document.getElementById("copy-access-token").addEventListener("click", () => {
        const combinedData = JSON.parse(localStorage.getItem("combinedData"));
        if (combinedData && combinedData.access_token) {
          navigator.clipboard
            .writeText(combinedData.access_token)
            .then(() => alert("Access token copied to clipboard!"))
            .catch((err) => alert("Failed to copy access token: " + err));
        } else {
          alert("No access token available to copy!");
        }
      });

      // Check for authorization code in URL
      handleOAuthFlow();
    </script>
  </body>
</html>
